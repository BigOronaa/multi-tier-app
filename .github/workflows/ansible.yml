name: Terraform + Ansible Multi-Tier Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
    # -----------------------------
    # 1. Checkout
    # -----------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -----------------------------
    # 2. Install dependencies
    # -----------------------------
    - name: Install Terraform, Ansible, jq
      run: |
        sudo apt update
        sudo apt install -y ansible jq python3-pip
        pip3 install pymysql docker

    # -----------------------------
    # 3. Configure SSH
    # -----------------------------
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        printf "%s\n" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

    # -----------------------------
    # 4. Terraform Init & Apply
    # -----------------------------
    - name: Terraform Init
      working-directory: environments/dev
      run: terraform init

    - name: Terraform Apply
      working-directory: environments/dev
      run: terraform apply -auto-approve

    # -----------------------------
    # 5. Export Terraform Outputs
    # -----------------------------
    - name: Export Terraform Outputs
      working-directory: environments/dev
      run: terraform output -json > tf_outputs.json

    # -----------------------------
    # 6. Generate Ansible Inventory
    # -----------------------------
    - name: Generate Ansible Inventory
      run: |
        mkdir -p ansible/inventory

        jq -r '
          "[mysql]\n" +
          .mysql_ip.value + " ansible_user=ubuntu\n\n" +

          "[wordpress]\n" +
          (.wordpress_ips.value | map(. + " ansible_user=ubuntu") | join("\n")) + "\n\n" +

          "[nodejs_todo]\n" +
          .nodejs_ip.value + " ansible_user=ubuntu\n\n" +

          "[load_balancer]\n" +
          .lb_ip.value + " ansible_user=ubuntu\n"
        ' environments/dev/tf_outputs.json > ansible/inventory/hosts.ini

    - name: Show Inventory (Debug)
      run: cat ansible/inventory/hosts.ini

    # -----------------------------
    # 7. Run Ansible Playbooks
    # -----------------------------
    - name: Configure MySQL
      run: |
        ansible-playbook -i ansible/inventory/hosts.ini \
          ansible/playbooks/mysql.yml

    - name: Configure WordPress
      run: |
        ansible-playbook -i ansible/inventory/hosts.ini \
          ansible/playbooks/wordpress.yml

    - name: Configure Node.js Todo App
      run: |
        ansible-playbook -i ansible/inventory/hosts.ini \
          ansible/playbooks/nodejs.yml

    - name: Configure Load Balancer
      run: |
        ansible-playbook -i ansible/inventory/hosts.ini \
          ansible/playbooks/loadbalancer.yml
