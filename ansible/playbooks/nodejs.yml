---
- name: Configure Node.js Todo server
  hosts: nodejs
  become: yes

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install required system packages
      apt:
        name:
          - curl
          - build-essential
        state: present

    - name: Add NodeSource Node.js 18.x repo
      shell: |
        curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
      args:
        creates: /etc/apt/sources.list.d/nodesource.list

    - name: Install Node.js
      apt:
        name: nodejs
        state: present

    - name: Install PM2 globally
      npm:
        name: pm2
        global: yes

    - name: Create app directory
      file:
        path: /home/ubuntu/todo-app
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Create Todo app file
      copy:
        dest: /home/ubuntu/todo-app/app.js
        content: |
          const http = require('http');
          const port = 3000;

          const server = http.createServer((req, res) => {
              res.writeHead(200, { 'Content-Type': 'text/plain' });
              res.end('Hello! This is your Todo App.\n');
          });

          server.listen(port, () => {
              console.log(`Server running on port ${port}`);
          });
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Start Todo app with PM2
      become_user: ubuntu
      shell: |
        pm2 start app.js --name todo-app || pm2 restart todo-app
      args:
        chdir: /home/ubuntu/todo-app

    - name: Save PM2 process list
      become_user: ubuntu
      shell: pm2 save
